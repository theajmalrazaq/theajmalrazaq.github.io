---
import "../../styles/global.css";
import { supabase } from "../../lib/supabaseClient";
import { marked } from "marked";
import NavbarSection from "../../components/NavbarSection.astro";
import Loading from "../../components/Loading.astro";
import FooterSection from "../../components/FooterSection.astro";
import MetaSection from "../../components/MetaSection.astro";

// Get all blog posts for navigation
export async function getStaticPaths() {
  const { data: blogs } = await supabase.from("blogs").select("slug");
  return (blogs ?? []).map((blog) => ({
    params: { slug: blog.slug },
  }));
}

const { slug } = Astro.params;

// Get current blog post
const { data: blog, error } = await supabase
  .from("blogs")
  .select("*")
  .eq("slug", slug)
  .single();

if (!blog) throw new Error("blog not found");

const html = marked(blog.content);
---

<!doctype html>
<html lang="en" class="lenis lenis--smooth select-none cursor-none">
  <MetaSection
    title={`${blog.title} | Ajmal Razaq `}
    description={blog.excerpt || "An article by Ajmal Razaq "}
    keywords={[
      "blog",
      "article",
      "frontend development",
      "UI/UX design",
      "ajmal razaq ",
    ]}
    socialImage={blog.img || "/images/social-share.png"}
    url={`https://theajmalrazaq.github.io/blog/${slug}`}
    type="article"
  />
  <body class="bg-black min-h-screen flex flex-col">
    <!-- Cursor Tracker -->
    <div
      id="cursor-tracker"
      class="fixed w-4 h-4 rounded-[0px] pointer-events-none z-[9999] flex items-center border-2 border-white/10 backdrop-blur-2xl bg-accent justify-center"
      style="transform: translate(-50%, -50%)"
    >
      <h1 class="font-nixel font-3xl" id="cursor-icon">a</h1>
    </div>

    <!-- Loading overlay -->
    <div
      id="loading-overlay"
      class="fixed top-0 left-0 w-full h-full flex items-center justify-center z-[9999] bg-black"
    >
      <Loading />
    </div>

    <NavbarSection />

    <main class="max-w-4xl mx-auto px-4 py-16 text-white flex-grow">
      <!-- Back to blogs link -->
      <a
        href="/blog"
        class="inline-flex items-center mb-6 text-accent/80 hover:text-accent transition-colors group"
        data-aos="focus-up"
        data-aos-delay="100"
      >
        <span
          class="mr-2 transform group-hover:-translate-x-1 transition-transform"
          >&larr;</span
        >
        <span>Back to all articles</span>
      </a>

      {
        blog.img && (
          <div
            class="img-container relative"
            data-aos="focus-up"
            data-aos-delay="300"
          >
            <figure class="overflow-hidden absolute left-0 top-0 z-[-1] h-[16rem] w-full pointer-events-none">
              <div
                class="img-blur lg:translate-y-[-20%]"
                style="position: relative; height: 0px; padding-top: 40%"
              >
                <div class="absolute inset-0 top-1/2">
                  <img
                    alt={blog.title}
                    title={blog.title}
                    fetchpriority="high"
                    width="1200"
                    height="480"
                    decoding="async"
                    class="w-full -translate-y-1/2"
                    src={blog.img}
                    style="color: transparent"
                  />
                </div>
              </div>
            </figure>
            <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/50 to-black/30" />
          </div>
        )
      }

      <div class="mb-8" data-aos="focus-up" data-aos-delay="400">
        <h1
          class="text-3xl sm:text-4xl md:text-5xl font-nixel tracking-[1px] mb-5 text-white"
          style="word-spacing: -5px;"
        >
          {blog.title}
        </h1>

        <div class="flex items-center gap-3 mb-6">
          <div
            class="w-8 h-8 rounded-full bg-accent/20 backdrop-blur-md flex items-center justify-center"
          >
            <span class="text-accent font-nixel">a</span>
          </div>
          <div>
            <p class="text-sm font-product-sans text-white">Ajmal Razaq</p>
            <p class="text-xs font-product-sans text-white/60">
              Published on {
                new Date(blog.created_at).toLocaleDateString("en-US", {
                  year: "numeric",
                  month: "long",
                  day: "numeric",
                })
              }
            </p>
          </div>
        </div>

        {
          blog.excerpt && (
            <div class="mb-8 py-4 px-6 bg-accent/5 border-l-2 border-accent rounded-r-[0px]">
              <p class="text-lg font-product-sans text-white/90 italic">
                {blog.excerpt}
              </p>
            </div>
          )
        }
      </div>

      <div class="w-full h-px bg-white/10 my-8"></div>

      <article
        class="prose prose-lg max-w-none font-product-sans prose-headings:font-nixel prose-headings:text-white
        prose-p:text-white/90 prose-a:text-accent hover:prose-a:text-accent/80 prose-strong:text-white prose-code:text-white/80
        prose-code:bg-white/10 prose-code:p-1 prose-code:rounded-[0px] prose-pre:bg-white/5 prose-pre:border
        prose-pre:border-white/10 prose-pre:rounded-[0px] prose-img:rounded-[0px] prose-img:border
        prose-img:border-white/10 prose-blockquote:border-l-accent prose-blockquote:bg-white/5
        prose-blockquote:border-white/10 prose-blockquote:rounded-[0px] prose-blockquote:p-4
        prose-h1:mt-10 prose-h2:mt-8 prose-h3:mt-6"
        data-aos="focus-up"
        data-aos-delay="500"
        set:html={html}
      />

      <!-- Related articles section -->
      <div class="mt-16 mb-12">
        <h3 class="text-2xl font-nixel text-white mb-6">More from the blog</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- This would be populated with related articles in a future implementation -->
          <div
            class="border border-white/10 rounded-[0px] p-4 bg-white/5 backdrop-blur-sm hover:bg-white/10 transition-colors"
          >
            <a href="#" class="block h-full">
              <h4 class="text-accent font-nixel mb-2">
                Check out other articles
              </h4>
              <p class="text-white/70 text-sm">
                Explore more content from the blog section
              </p>
            </a>
          </div>
          <div
            class="border border-white/10 rounded-[0px] p-4 bg-white/5 backdrop-blur-sm hover:bg-white/10 transition-colors"
          >
            <a href="/blog" class="block h-full">
              <h4 class="text-accent font-nixel mb-2">Back to blog index</h4>
              <p class="text-white/70 text-sm">
                See all the latest articles and updates
              </p>
            </a>
          </div>
        </div>
      </div>
    </main>

    <!-- New Footer Component -->
    <FooterSection />

    <script type="module" src="/script.js"></script>
  </body>
</html>
