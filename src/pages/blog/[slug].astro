---
import "../../styles/global.css";
import { supabase } from "../../lib/supabaseClient";
import { marked } from "marked";
import NavbarSection from "../../components/NavbarSection.astro";
import Loading from "../../components/Loading.astro";
import CursorTracker from "../../components/CursorTracker.astro";
import FooterSection from "../../components/FooterSection.astro";
import MetaSection from "../../components/MetaSection.astro";
import LikeView from "../../components/blog/LikeView.jsx";
import ViewsCount from "../../components/blog/ViewsCount.jsx";
import LikesCount from "../../components/blog/LikesCount.jsx";

// Get all blog posts for navigation
export async function getStaticPaths() {
  const { data: blog } = await supabase.from("blog").select("slug");
  return (blog ?? []).map((blog) => ({
    params: { slug: blog.slug },
  }));
}

const { slug } = Astro.params;

// Get current blog post
const { data: blog, error } = await supabase
  .from("blog")
  .select("*")
  .eq("slug", slug)
  .single();

if (!blog) throw new Error("blog not found");

const html = marked(blog.content);
---

<!doctype html>
<html lang="en" class="lenis lenis--smooth select-none">
  <MetaSection
    title={`${blog.title} | Ajmal Razaq `}
    description={blog.excerpt || "An article by Ajmal Razaq "}
    keywords={[
      "blog",
      "article",
      "frontend development",
      "UI/UX design",
      "ajmal razaq ",
    ]}
    socialImage={blog.img || "/images/social-share.png"}
    url={`https://theajmalrazaq.github.io/blog/${slug}`}
    type="article"
  />

  <body class="bg-black min-h-screen flex flex-col">
    <!-- Cursor Tracker -->
    <CursorTracker />
    <Loading />
    <NavbarSection page="blog" />

    <main class="flex-grow">
      <!-- Hero Section with Cover Image -->
      <section class="relative">
        {
          blog.img && (
            <div>
              <figure class="overflow-hidden absolute left-0 top-0 z-[-1] h-[16rem] w-full pointer-events-none">
                <div
                  class="img-blur lg:translate-y-[-20%]"
                  style="position: relative; height: 0px; padding-top: 40%;"
                >
                  <div class="absolute inset-0 top-1/2">
                    <img
                      alt={blog.title}
                      title={blog.title}
                      fetchpriority="high"
                      width="1200"
                      height="480"
                      decoding="async"
                      class="w-full -translate-y-1/2"
                      src={blog.img}
                      style="color: transparent"
                    />
                  </div>
                </div>
              </figure>
              <div class="absolute left-0 top-0 h-[16rem] w-full bg-gradient-to-b from-black/60 to-black z-[-1]" />
            </div>
          )
        }

        <!-- Header Content -->
        <div class="max-w-4xl mx-auto px-4 pb-12 pt-32 md:pb-20 md:pt-64">
          <div class="pb-4" data-aos="focus-up" data-aos-delay="300">
            <div class="flex flex-wrap gap-x-2 gap-y-1 text-sm">
              {
                blog.tags &&
                  blog.tags
                    .split(",")
                    .map((tag: string) => tag.trim())
                    .map((tag: string) => (
                      <button class="blog-tag cursor-auto inline-block rounded-md px-1.5 py-0.5 font-medium bg-white/10 text-white/70 border border-white/20 disabled:opacity-40">
                        {tag}
                      </button>
                    ))
              }
            </div>
            <h1
              class="gradient-text text-3xl sm:text-4xl md:text-5xl font-nixel tracking-[1px] mt-6 leading-tight lowercase"
              style="word-spacing: -7px;"
              data-aos="focus-up"
              data-aos-delay="400"
            >
              {blog.title}
            </h1>

            {
              blog.excerpt && (
                <p
                  class="text-lg font-product-sans text-white/90 mt-1"
                  data-aos="focus-up"
                  data-aos-delay="500"
                >
                  {blog.excerpt}
                </p>
              )
            }

            <div
              class="mt-12 flex gap-3 items-center"
              data-aos="focus-up"
              data-aos-delay="600"
            >
              <div class="w-10 h-10 rounded-full overflow-hidden">
                <div
                  class="w-full h-full bg-accent/20 backdrop-blur-md flex items-center justify-center"
                >
                  <span class="text-accent font-nixel text-lg">a</span>
                </div>
              </div>
              <div>
                <p class="text-sm font-product-sans text-white">Ajmal Razaq</p>
                <p class="text-xs font-product-sans text-white/60">
                  {
                    new Date(blog.created_at).toLocaleDateString("en-US", {
                      year: "numeric",
                      month: "long",
                      day: "numeric",
                    })
                  }
                </p>
              </div>
            </div>

            <div
              class="mt-12 py-4 bg-black border border-white/10 rounded-3xl px-3 flex items-center gap-5 flex-wrap"
              data-aos="focus-up"
              data-aos-delay="700"
            >
              <p class="text-xs text-white/60 flex items-center gap-2">
                ðŸ™„
                <ViewsCount blogId={blog.id} client:load /> views
              </p>

              <p class="text-xs text-white/60 flex items-center gap-2 ml-auto">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="w-4 h-4 text-white/40"
                >
                  <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                  <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                </svg>
                <span>{blog.avg_read_time || 5} min read</span>
              </p>

              <div class="flex items-center gap-2">
                ðŸ«¶
                <span class="text-xs text-white/60">
                  <LikesCount blogId={blog.id} client:load /> likes
                </span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Article Content Section -->
      <section class="mt-6">
        <div class="max-w-7xl mx-auto px-4">
          <div class="max-w-4xl mx-auto">
            <!-- Main Content Column -->
            <div class="min-w-0">
              <article
                class="prose prose-base max-w-none font-product-sans prose-headings:font-nixel prose-headings:text-white prose-headings:lowercase prose-headings:tracking-[1px]
                prose-p:text-white/90 prose-p:text-sm prose-p:leading-relaxed prose-a:text-accent hover:prose-a:text-accent/80
                prose-strong:text-white prose-code:text-white/80 prose-code:text-sm
                prose-code:bg-white/10 prose-code:p-1 prose-code:rounded-[0px] prose-pre:bg-white/5 prose-pre:border
                prose-pre:border-white/10 prose-pre:rounded-[0px] prose-pre:text-sm prose-img:rounded-[0px] prose-img:border
                prose-img:border-white/10 prose-blockquote:border-l-accent prose-blockquote:bg-white/5
                prose-blockquote:border-white/10 prose-blockquote:rounded-[0px] prose-blockquote:p-4 prose-blockquote:text-sm
                prose-h1:mt-8 prose-h2:mt-6 prose-h3:mt-4 prose-h2:text-xl prose-h3:text-lg prose-h4:text-base
                prose-headings:scroll-mt-24 prose-li:text-sm prose-ul:text-sm prose-ol:text-sm"
                data-aos="focus-up"
                data-aos-delay="500"
                set:html={html}
              />

              <!-- Like and View Component -->
              <div class="mt-12 mb-8" data-aos="focus-up" data-aos-delay="600">
                <LikeView
                  client:load
                  blogId={blog.id}
                  initialViews={blog.views_count || 0}
                  initialLikes={blog.likes_count || 0}
                />
              </div>
            </div>
          </div>
        </div>
        <!-- New Footer Component -->
        <FooterSection />

        <script type="module" src="/script.js"></script>
      </section>
    </main>
  </body>
</html>
