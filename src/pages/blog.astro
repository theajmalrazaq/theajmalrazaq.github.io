---
import "../styles/global.css";
import { supabase } from "../lib/supabaseClient";
import NavbarSection from "../components/NavbarSection.astro";
import Loading from "../components/Loading.astro";
import FooterSection from "../components/FooterSection.astro";
import CursorTracker from "../components/CursorTracker.astro";
import blogImage from "../../public/images/blog.svg";
import MetaSection from "../components/MetaSection.astro";
import { Eye, Search, HeartHandshake } from "@lucide/astro";
import ViewsCount from "../components/blog/ViewsCount.jsx";
import LikesCount from "../components/blog/LikesCount.jsx";

// Get all blog posts (static data at build time)
const { data: blog, error } = await supabase
  .from("blog")
  .select("*")
  .order("created_at", { ascending: false });
if (error) console.error("Error fetching blog:", error);

const allTags = blog
  ? [
      ...new Set(
        blog
          .filter((blog) => blog.tags) // Filter out blog without tags
          .flatMap((blog) =>
            blog.tags.split(",").map((tag: string) => tag.trim())
          )
      ),
    ] // Split each tag string and trim whitespace
  : [];
---

<!doctype html>
<html lang="en" class="lenis lenis--smooth select-none">
  <MetaSection
    title="Blog | Ajmal Razaq "
    description="Articles and thoughts by Ajmal Razaq  on frontend development, UI/UX design, and more."
    keywords={[
      "blog",
      "articles",
      "frontend development",
      "UI/UX design",
      "ajmal razaq ",
    ]}
    url="https://theajmalrazaq.github.io/blog"
    type="website"
  />

  <!-- Supabase configuration for client-side scripts -->
  <meta name="supabase-url" content={import.meta.env.PUBLIC_SUPABASE_URL} />
  <meta
    name="supabase-key"
    content={import.meta.env.PUBLIC_SUPABASE_ANON_KEY}
  />
  <body class="bg-black min-h-screen flex flex-col">
    <!-- Cursor Tracker -->
    <CursorTracker />
    <!-- Loading overlay -->
    <Loading />
    <!--Navbar -->
    <NavbarSection page="blog" />

    <main class="max-w-6xl mx-auto px-4 py-16 text-white flex-grow">
      <!-- Background Pattern -->
      <div
        class="absolute w-full h-full animate-pulse -top-50 inset-0 pointer-events-none z-[1]"
        aria-hidden="true"
      >
        <img
          decoding="async"
          loading="lazy"
          width="1920"
          height="1330"
          sizes="100vw"
          srcset="https://framerusercontent.com/images/2ZTM81mdCXeMIbSWfvdh4X7JIGg.png?scale-down-to=512 512w,
                https://framerusercontent.com/images/2ZTM81mdCXeMIbSWfvdh4X7JIGg.png?scale-down-to=1024 1024w,
                https://framerusercontent.com/images/2ZTM81mdCXeMIbSWfvdh4X7JIGg.png 1920w"
          src="https://framerusercontent.com/images/2ZTM81mdCXeMIbSWfvdh4X7JIGg.png"
          alt="Background pattern"
          class="w-full h-full object-cover opacity-50 animate-pulse"
        />
      </div>

      <!-- Hero Section -->
      <div
        class="relative flex flex-col justify-center mt-20 items-center w-full mb-12 text-center z-[2]"
        data-aos="text-focus-fade-up"
        data-aos-delay="200"
      >
        <div
          class="bg-gradient-to-b from-white from-20% to-accent to-70% bg-clip-text text-transparent"
        >
          <img
            src={blogImage.src}
            alt="Blog Image"
            class="p-2"
            data-aos="focus-up"
            data-aos-duration="1000"
            data-aos-delay="800"
          />
        </div>
        <p data-fade="3" class="b1 mt-3">
          <span
            class="transition-colors bg-gradient-to-r from-neutral-300/[35%] via-neutral-300/90 to-neutral-300/[35%] bg-clip-text text-transparent font-product-sans"
            >Thoughts, tutorials, and insights on frontend development and
            design</span
          >
        </p>

        <!-- Search Bar -->
        <div
          class="max-w-2xl w-full mx-auto mt-8"
          data-aos="text-focus-fade-up"
          data-aos-delay="300"
        >
          <div class="relative flex">
            <input
              type="text"
              id="search-input"
              placeholder="Search articles..."
              class="w-full px-5 py-3 border border-white/10 rounded-full text-white focus:outline-none bg-black shadow-accent focus:border-accent/50 transition-all"
            />
            <button
              id="search-button"
              class="absolute right-4 top-1/2 -translate-y-1/2"
            >
              <Search class="h-5 w-5 text-white/50" />
            </button>
          </div>

          <!-- Tag Pills -->
          <div class="flex flex-wrap gap-3 mt-6 justify-center">
            <button
              id="filter-all"
              class="text-sm px-4 py-2 rounded-full border border-accent bg-accent text-white filter-active"
            >
              All
            </button>
            {
              allTags.map((tag, index) => {
                return (
                  <button
                    class={`text-sm px-4 py-2 rounded-full border border-white/10  hover:bg-accent hover:text-white hover:scale-[1.01] transition-colors filter-tag shadow-accent`}
                    data-tag={tag}
                    data-aos="focus-up"
                  >
                    {tag}
                  </button>
                );
              })
            }
          </div>
        </div>

        <!-- Horizontal Line -->
        <div class="w-full max-w-5xl mx-auto mt-8">
          <hr class="border-white/10 border-t" />
        </div>
      </div>

      <!-- Two-column Layout -->
      <div class="flex flex-col z-[2] gap-8">
        <!-- No Results Message -->
        <div id="no-results-message" class="hidden text-center py-10">
          <Search class="h-12 w-12 mx-auto text-white/30 mb-4" />
          <h3
            class="text-2xl font-nixel tracking-[1px] text-white/70 mb-2"
            style="word-spacing: -7px;"
          >
            no results found
          </h3>
          <p class="text-white/50">Try different keywords or remove filters</p>
        </div>

        <!-- Left Column: Blog Posts -->
        <div id="blog-posts-container">
          {
            blog &&
              blog.map((blog) => (
                <a
                  href={`/blog/${blog.slug}`}
                  class="blog-card group rounded-3xl border border-white/10 overflow-hidden flex flex-col h-full transition-all duration-300 ease-in-out group mb-8 shadow-accent-soft"
                  data-aos="focus-up"
                  data-tags={blog.tags}
                  data-blog-id={blog.id}
                >
                  <div class="p-5 flex sm:flex-row flex-col-reverse justify-between gap-6">
                    <div class="flex flex-col sm:w-1/2 w-full justify-between">
                      <div class="flex justify-between items-center text-xs text-white/60 mb-2">
                        <span>
                          {new Date(blog.created_at).toLocaleDateString(
                            "en-US",
                            {
                              month: "long",
                              day: "2-digit",
                              year: "numeric",
                            }
                          )}
                        </span>
                      </div>
                      <h2
                        class="text-2xl font-nixel tracking-[1px] text-white mb-2 group-hover:text-accent"
                        style="word-spacing: -7px;"
                      >
                        {blog.title}
                      </h2>
                      <p class="text-sm text-white/80 mb-4 line-clamp-3 flex-grow">
                        {blog.excerpt}
                      </p>
                      <div class="flex justify-between items-center mt-auto pt-4 text-xs text-white/60 border-t border-white/10">
                        <div class="flex items-center gap-6">
                          <div class="flex items-center gap-1">
                            ðŸ™„
                            <ViewsCount blogId={blog.id} client:load />
                            Views
                          </div>
                          <div class="flex items-center gap-1">
                            ðŸŒ€
                            <LikesCount blogId={blog.id} client:load /> Aura
                            Point
                          </div>
                          <span>{blog.avg_read_time} min read</span>
                        </div>
                      </div>
                    </div>
                    <img
                      src={blog.img}
                      alt={blog.title}
                      class="sm:w-[200px] w-full aspect-video transition-transform duration-500 rounded-2xl"
                    />
                  </div>
                </a>
              ))
          }
        </div>

        <!-- Load More Button -->
        <div
          id="load-more-container"
          class="flex justify-center mt-12"
          data-aos="focus-up"
          data-aos-delay="100"
        >
          <button
            id="load-more-btn"
            class="hidden px-8 py-3 rounded-full border border-white/10 bg-black/50 text-white hover:bg-accent hover:border-accent hover:text-white transition-all duration-300 hover:scale-[1.02] font-medium"
          >
            Load More
          </button>

          <!-- Loading State -->
          <div id="loading-indicator" class="hidden">
            <div class="flex items-center gap-3">
              <div
                class="animate-spin rounded-full h-5 w-5 border-2 border-accent border-t-transparent"
              >
              </div>
              <span class="text-white/70">Loading more articles...</span>
            </div>
          </div>

          <!-- End of Posts Message -->
          <div id="end-of-posts" class="hidden text-center py-6">
            <p class="text-white/50">You've reached the end of our articles</p>
          </div>
        </div>
      </div>
    </main>
    <!-- New Footer Component -->
    <FooterSection />
    <script type="module" src="/script.js"></script>
  </body>
</html>
